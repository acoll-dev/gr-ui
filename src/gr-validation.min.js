angular.module("grValidation",["grValidation.provider","grValidation.directive"]),angular.module("grValidation.provider",["grScriptbind"]).provider("$grValidation",function(){var i,s,o,a=1,l=1,r={compile:{},injector:{},scriptbind:{},filter:{},http:{},scope:{},timeout:{},window:{}},f={config:{},fields:{},masks:{},rules:{}};o={config:{form:[],file:{mask:{},message:{},template:{},$mask:{url:"",config:{},set:function(e){angular.forEach(e,function(e,t){o.config.file.mask[t]=e})}},$message:{url:"",set:function(e){o.config.file.message=e}},$template:{path:"",extension:"",set:function(){angular.forEach(o.field,function(e,t){o.config.file.template[t]=o.config.file.$template.path+"/"+e.template+o.config.file.$template.extension}),o.config.file.template.form=o.config.file.$template.path+"/form"+o.config.file.$template.extension,o.config.file.template.alert=o.config.file.$template.path+"/alert"+o.config.file.$template.extension},get:function(e,t){return t?o.config.file.template[o.field[e].template]:e?o.config.file.template[e]:o.config.file.template}}},$form:{set:function(e){angular.forEach(e,function(e,t){o.config.form[t]=e,o.config.form.length++})}}},"default":{method:"onSubmit",labelType:"placeholder",validate:!0},form:{},field:{},rules:{0:{name:"required",type:"boolean",rule:function(e){return""!==e&&null!==e&&void 0!==e&&"undefined"!==e&&"on"!==e&&e}}},translator:{enable:!1,module:""},$destroy:function(e){return"all"!==e?o.form[e]?void delete o.form[e]:void 0:void(o.form={})},$field:{set:function(e){e?angular.forEach(e,function(e,t){o.field[t]=e}):console.error("Fields configuration file not found.")}},$get:function(e){if(e&&"string"===String(typeof e)&&"external"!==e){var e=o.form[e];return e?{element:e.element,grForm:e.grForm,id:e.id,name:e.name,noAjaxSubmit:e.$noAjaxSubmit,reset:e.$reset,submit:e.$validate,translate:e.translate,$add:e.$add,$change:e.$change,$message:{get:e.$message.get,show:e.$message.show}}:void 0}if("external"===e){var t={};return angular.forEach(o.form,function(e,a){t[a]=e.$get()}),t}},$new:function(e){o.form[e.name]?(console.error("Not allowed to use two forms with a same name, '"+e.name+"' is already being used in another form."),e.element.remove()):(e={data:{},dataSource:""!==e.dataSource&&void 0!==e.dataSource?e.dataSource:"",dependence:[],element:e.element,error:{},field:{},grForm:!0,id:a,labelType:""!==e.labelType&&void 0!==e.labelType?e.labelType:o.default.labelType,method:""!==e.method&&void 0!==e.method?e.method:o.default.method,model:e.model,name:e.name,scope:e.scope,translate:!0,validated:!1,validate:""!==e.validate&&void 0!==e.validate?"false"!==e.validate&&e.validate!==!1:o.default.validate,valid:!1,$add:function(t){e.field[t.name]?(console.error("Not allowed to use two input fields with the same gr-name on the same form, '"+t.name+"' is already been used in '"+e.name+"' form."),t.element.remove()):(o.form[t.form]?t={attrs:{icon:t.attrs.icon,label:s.translate(e,t.attrs.label),mask:t.attrs.mask,type:t.attrs.type,dataSource:t.attrs.dataSource},changed:!1,"default":{value:t.value,checked:t.checked,multiple:t.multiple,innerElements:t.innerElements},element:t.element,error:"",error_messages:s.rules.parse(e,t.name,t.validate),form:t.form,id:l,innerElements:t.innerElements,input:angular.element(t.element).find(o.field[t.attrs.type].type),model:[],name:t.name,rules:s.rules.split(t.validate),requiredBy:[],scope:t.scope,state:"",validate:t.validate?!0:!1,valid:!0,value:"",$change:function(a){a&&(0===t.model.length&&(t.model=a.model),t.value=void 0!==a.value&&""!==a.value?a.submiting?t.value:a.value:void 0!==t.default.value&&""!==t.default.value?t.default.value:"",t.model.$setViewValue(t.value));var n=t.value,l=t.model;if(e.validate){if("onSubmit"===e.method&&!e.validated)return void r.timeout(function(){r.window.trigger("resize")});if("onChange"===e.method&&!t.changed&&!e.validated)return r.timeout(function(){r.window.trigger("resize")}),void(t.changed=!0);t.$check(n,l)}r.timeout(function(){r.window.trigger("resize")})},$check:function(a,n){var l=0;t.validate?(angular.forEach(o.rules,function(n){t.rules[n.name]&&0===l&&(n.rule(a,t.rules[n.name],e.field,t)?e.$error.unset(t.id):(e.$error.set({id:t.id,message:t.error_messages[n.name]}),l++),e.$message.change("danger","form"),e.$change())}),0===l?(t.$state.set("success"),t.valid=!0,n.$setValidity(t.name,!0)):(t.$state.set("error"),t.valid=!1,n.$setValidity(t.name,!1))):(e.$change(),t.valid=!0,n.$setValidity(t.name,!0))},$config:function(){t.$mask.set(),t.rules.hasOwnProperty("equalTo")&&o.form[t.form].field[t.rules.equalTo].requiredBy.push(t.name),o.form[t.form].field[t.name]=t,l++},$data:{set:function(a){var n=function(){a?o.field[t.attrs.type].set.data(a,t):(o.field[t.attrs.type].set.defaultData(e.data[t.name],t),o.field[t.attrs.type].set.attrs(e,t),o.field[t.attrs.type].set.scope(e,t))};t.attrs.dataSource?r.http.get(t.attrs.dataSource).then(function(e){o.field[t.attrs.type].set.defaultData(e.data.response,t),n()},function(){n()}):n()}},$mask:{object:{},type:"",set:function(){t.attrs.mask&&(o.config.file.mask[t.attrs.mask]?(t.$mask.type="string",t.attrs.mask=o.config.file.mask[t.attrs.mask]):(t.$mask.type="string",t.attrs.mask=""))}},$modelName:function(e){var t=/[a-zA-Z0-9]+/g,a=/[^a-zA-Z0-9]+/g,n=[],l=!1;return a.test(e)?(angular.forEach(e.split(""),function(e){e.match(t)?(l&&(e=e.toUpperCase(),l=!1),n.push(e)):l=!0}),n.join("")):e},$reset:function(){t.$state.set(""),t.model.$setViewValue(t.default.value),o.field[t.attrs.type].reset(e,t),t.$change({value:"",model:t.model})},$state:{set:function(e){t.state=e,t.scope.state=e}}}:r.timeout(function(){o.$add(t)}),t.$config(),e.$data.hasData||t.$data.set())},$change:function(t){t?(e.field[t.field].$change(t),e.field[t.field].requiredBy.length>0&&angular.forEach(e.field[t.field].requiredBy,function(t){e.field[t].$change()})):r.scope.$broadcast("form"+e.name+"change")},$check:function(){return void 0===e.valid?!1:e.valid===!0},$config:function(){e.$scope(),e.model.$id=String(e.id),e.model.$name=e.name;var t=r.scriptbind.get(),n=0;if(angular.forEach(t,function(){n++}),n>0){var l=r.scriptbind.get("grForm/form")[0][0][e.name];angular.isFunction(l)&&(o.config.form[e.name]=r.scriptbind.get("grForm/form")[0][0][e.name])}if(o.config.form.hasOwnProperty(e.name)){var i=o.config.form[e.name](e.scope);if(i.hasOwnProperty("submit")&&e.$submit.set(i.submit),""!==e.dataSource&&(i["data-source"]=e.dataSource),i.hasOwnProperty("data-source")){var s=i["data-source"];e.$data.hasData=!0,"string"==typeof s?r.http.get(s).then(function(t){e.data=t.data.response,angular.forEach(e.field,function(e){e.$data.set()})},function(e){console.error(e)}):"object"==typeof s&&(e.data=s)}i.hasOwnProperty("translate")&&"boolean"==typeof i.translate&&(e.translate=i.translate),i.hasOwnProperty("inject")&&e.$dependece.set(i.inject)}else console.error('Not found configuration of "'+e.name+'" form, so it is not possible to send or receive data.');e.element.bind({submit:function(t){t.preventDefault(),e.$validate()},reset:function(t){t.preventDefault(),e.$reset()}}).attr("novalidate",!0),o.form[e.name]=e,a++},$data:{hasData:!1,set:function(e){o.data=e}},$dependece:{set:function(t){"string"==typeof t?e.dependence=config.inject:angular.forEach(t,function(t){e.dependence.push(t)})}},$error:{set:function(t){e.error[t.id]=t.message,e.valid=!1},unset:function(t){delete e.error[t];var a=0;angular.forEach(e.error,function(){a++}),e.valid=0===a?!0:!1}},$get:function(){return{data:function(t){if(!t){var a={};return angular.forEach(e.field,function(e){a[e.name]=e.value}),a}"object"==typeof t&&angular.forEach(t,function(t,a){e.field[a]&&e.field[a].$data.set(t)})},element:e.element,grForm:e.grForm,noAjaxSubmit:e.$noAjaxSubmit,reset:e.$reset,submit:e.$validate,translate:e.translate}},$message:{type:"",trigger:"",text:{},get:function(){var t={};return"object"==String(typeof e.$message.text)?angular.forEach(e.$message.text,function(e,a){t[a]=e}):t=e.$message.text,{type:e.$message.type,trigger:e.$message.trigger,text:t}},change:function(t,a,n){e.$message.type=t,e.$message.trigger=a,e.$message.text=n&&"form"!==a?n:e.error,e.$change(),r.timeout(function(){r.window.trigger("resize")})},show:function(t,a){e.$message.change(t,"show",s.translate(e,a))}},$noAjaxSubmit:function(t,a,n){return t?(a=methos||"POST",n=n||"multipart/form-data",void e.element[0].attr({action:t,method:a,enctype:n}).submit()):!1},$status:{set:function(t){"boolean"===String(typeof t)&&(e.validate=t)}},$scope:function(){e.scope.form={reset:e.$reset,submit:e.$validate},e.scope.__=s.translate},$submit:{fn:"",set:function(t){e.$submit.fn=t},exec:function(t){var a=e.$submit.fn;if("function"===String(typeof a))a(t);else{var n,s,l=[],i=0;angular.forEach(a,function(t){"string"==typeof t?(n=angular.isArray(e.dependence)&&e.dependence.length>0?angular.injector(e.dependence):r.injector,l.push(n.get(t)),i++):"function"==typeof t&&"function"!=typeof s&&(s=t)}),l.push(t),l.push(o.$get(e.name)),s.apply(null,l)}}},$reset:function(){e.validated=!1,e.valid=!0,angular.forEach(e.field,function(e){e.$reset()}),e.$message.type="",e.$message.trigger="",e.$message.text={},r.scope.$broadcast("form"+e.name+"change")},$validate:function(){if(e.validate){if(e.validated=!0,angular.forEach(e.field,function(e){r.scope.$broadcast(e.form+e.name+"submit")}),e.$check()){var t=e.$get().data();return void e.$submit.exec(t)}var a;return angular.forEach(e.field,function(e){e.valid||a||(a=e.input)}),void a.focus()}e.$submit.exec(e.element.serializeArray())}},e.$config())},$rule:{set:function(e){angular.forEach(e,function(e,t){if("function"===String(typeof e.rule)){var a=0,n=0;angular.forEach(o.rules,function(l,r){l.name===t&&(o.rules[r]={name:t,type:e.type,rule:e.rule,parse:e.parse?e.parse:!1},a++),n++}),0===a&&(o.rules[n]={name:t,type:e.type,rule:e.rule,parse:e.parse?e.parse:!1})}})}},$translator:{set:function(e){o.translator.enable=e.enable,o.translator.module=e.module}}},s={translate:function(e,t){function a(e){return o.translator.enable&&"pascalprecht.translate"===o.translator.module?r.filter("translate")(e):e}return"object"==typeof e&&e.grForm?e.translate?a(t):t:"string"==typeof e?a(e):"string"==typeof t?t:""},mask:{replace:function(e){for(var t=/[\/\\\.\_\-\(\)\:\%\?\!\+\=\@\&\Âª\Âº\Â¹\Â²\Â³\R\$\Â£\Â¢\ ]/g;e.match(t);)e=e.replace(t,"");return e},split:function(e){var t="";return-1!==e.indexOf("|")?(t=[],angular.forEach(e.split("|"),function(e,a){for(var n=e;-1!==n.indexOf(" ");)n=n.replace(" ","");t[a]={mask:e.trim(),length:n.trim().length}}),t.sort(function(e,t){return e.length-t.length})):t=e.trim(),t}},rules:{split:function(e){e=""!==e&&void 0!==e&&e?e:"required:false",e=e.split(",");var t={};return e&&angular.forEach(e,function(e){e=e.split(":");for(var a=e[0].trim(),n=e[1].trim(),l=!1;-1!=n.indexOf("'");)n=n.replace("'","").trim();angular.forEach(o.rules,function(e){if(a===e.name){var t=e.type;"integer"===t?n=parseInt(n)||"":"float"===t?n=parseFloat(n)||"":"boolean"===t?n="true"===String(n):"string"===t&&(n=String(n)||""),("integer"===t||"float"===t)&&(t="number"),typeof n===t&&(l=!0)}}),l&&(t[a]=n)}),t},parse:function(e,t,a){var n=o.config.file.message[t],l={};return a=s.rules.split(a),angular.forEach(a,function(a,r){if(!n)return void console.error('No error message was defined for "'+t+'" field.');if(n[r]){var i,u;angular.forEach(o.rules,function(e){e.name==r&&(u=e)}),n[r]=s.translate(e,n[r]),u.parse?(i=n[r],i=u.parse(i,a)):i=n[r],l[r]=i}else console.error('No error message was defined for "'+r+'" in "'+t+'" field.')}),l}}},this.destroy=o.$destroy,this.config=function(e){if(e.hasOwnProperty("config")&&"object"==typeof e.config&&o.config.$form.set(e.config),e.hasOwnProperty("files")){var t=e.files;t.hasOwnProperty("templates")?(o.config.file.$template.path=t.templates.location||"",o.config.file.$template.extension=t.templates.extension||".html"):(o.config.file.$template.path="",o.config.file.$template.extension=".html"),t.hasOwnProperty("messages")?o.config.file.$message.url=t.messages:console.error("Form messages files not found!"),t.hasOwnProperty("masks")&&(o.config.file.$mask.url=t.masks)}else o.config.file.$template.path="",o.config.file.$template.extension=".html",console.error("Form messages files not found!");if(e.hasOwnProperty("translator")||e.translator){var a={enable:e.translator.enable||!1,module:e.translator.enable?e.translator.module:""};o.$translator.set(a)}},this.showMessage=o.config.file.$message.show,i=function(e){r.injector=e,r.scriptbind=r.injector.get("$grScriptbind"),r.scope=r.injector.get("$rootScope"),r.filter=r.injector.get("$filter"),r.http=r.injector.get("$http"),r.compile=r.injector.get("$compile"),r.timeout=r.injector.get("$timeout"),r.window=angular.element(r.injector.get("$window")),f.fields=r.injector.get("$grValidation.fields"),o.$field.set(f.fields),f.rules=r.injector.get("$grValidation.rules"),o.$rule.set(f.rules),f.masks=r.injector.get("$grValidation.mask.patterns"),o.config.file.$mask.config=f.masks,o.config.form&&0!==o.config.form.length||(f.config=r.injector.get("$grValidation.config"),o.config.$form.set(f.config)),r.http.get(o.config.file.$message.url).then(function(e){var t={};angular.forEach(e.data,function(e,a){t[a]={},angular.forEach(e,function(e,n){t[a][n]=e,o.translate&&(t[a][n]=s.translate(e))})}),o.config.file.$message.set(t)},function(e){console.error(e)}),r.http.get(o.config.file.$mask.url).then(function(e){o.config.file.$mask.set(e.data)}),o.config.file.$template.set()},this.$get=["$injector",function(e){return i(e),{"new":o.$new,get:o.$get,mask:o.config.file.$mask.config,template:o.config.file.$template.get,destroy:o.$destroy,translate:s.translate}}]}).config(["$grScriptbindProvider",function(e){e.addType("grForm/form",function(e,t){var a=angular.isArray(t)&&angular.isArray(t[0])?t.shift():void 0,n=t;angular.forEach(e,function(e){var t=angular.isFunction(e[0])?e[0].apply(null,a):e[0][0].apply(null,a);if(t.inject){var l=[],r=angular.injector(t.inject),i=t.submit.pop(),s=r.get(t.submit);l.push(s),angular.isArray(n)&&angular.forEach(n,function(e){l.push(e)}),i.apply(null,l)}})})}]),angular.module("grValidation.directive",["grValidation.provider"]).directive("grForm",["$grValidation",function(e){return{restrict:"E",transclude:!0,replace:!0,scope:!1,templateUrl:e.template("form"),require:"?^form",compile:function(){return{pre:function(t,a,n,l){n.grName?e.new({name:n.grName,element:a,scope:t,model:l,method:n.hasOwnProperty("grValidateMethod")?n.grValidateMethod:"",validate:n.hasOwnProperty("grValidate")?n.grValidate:"",labelType:n.hasOwnProperty("grLabelType")?n.grLabelType:"",dataSource:n.hasOwnProperty("grDataSource")?n.grDataSource:""}):(console.error('"gr-name" attribute not found.'),a.html(""))},post:function(t,a,n){n.grName&&(t.grForm=e.get("external"))}}}}}]).directive("grAlert",["$grValidation","$timeout",function(e){return{restrict:"A",scope:!0,templateUrl:e.template("alert"),require:"?^form",link:function(t,a,n,l){if(l&&l.$name&&l.$id){var r=e.get(l.$name);t.message={text:{},type:"",error:{title:e.translate(r,"Oops, something is wrong")},length:0,check:function(){return t.message.length>0}},t.$on("form"+l.$name+"change",function(){var e=r.$message.get();t.message.length=0,t.message.text=e.text,t.message.trigger=e.trigger,t.message.type=e.type,angular.forEach(e.text,function(){t.message.length++})})}}}}]).directive("grInput",["$grValidation","$compile",function(e){return{restrict:"E",replace:!0,scope:!0,require:"?^form",transclude:!0,templateUrl:function(t,a){return a.grType||(a.grType="text"),e.template(a.grType,!0)},compile:function(){var l,r;return{post:function(t,a,n,i){if(i&&i.$name&&i.$id){l=e.get(i.$name),r=a.find("gr-input-inner");var s={};r.length>0&&angular.forEach(r,function(e,t){s[t]={},angular.forEach(e.attributes,function(e){var a=e.nodeName,n=e.value;("class"!==a||"ng-scope"!==n)&&(s[t][a]="undefined"!==n&&""!==n?n:!0)})}),l.$add({form:i.$name,name:n.grName,element:a,innerElements:s,scope:t,validate:""!==n.grValidate&&void 0!==n.grValidate?n.grValidate:!1,attrs:{type:""!==n.grType&&void 0!==n.grType?n.grType:"text",mask:n.grMask,label:n.grLabel,icon:""!==n.grIcon&&void 0!==n.grIcon?n.grIcon:!1,value:n.grValue,checked:n.hasOwnProperty("grChecked")?!0:!1,multiple:n.hasOwnProperty("grMultiple")?!0:!1,dataSource:n.hasOwnProperty("grDataSource")?n.grDataSource:!1}}),a.find("gr-input-inner").parent().remove()}}}}}}]).directive("grValidator",["$grValidation",function(e){return{restrict:"A",scope:{model:"=ngModel"},priority:1,require:["?^form","ngModel"],compile:function(){return{post:function(t,a,n,l){var r=l[0],i=l[1];if(i&&r&&i.$name&&r.$name&&r.$id&&(i.$setValidity(i.$name,!1),i.$formatters=[],i.$parsers=[],n.grValidator===!0||"true"===n.grValidator||n.grValidator===!1||"false"===n.grValidator)){var s=e.get(r.$name),o=function(e,t){s.$change({field:i.$name,model:i,value:e,submiting:t|!1})};t.$watch("model",function(e){o(e)}),t.$on(r.$name+i.$name+"submit",function(){o(a.val(),!0)})}}}}}}]).directive("grMaskPattern",["$grValidation","$parse","$timeout",function(e,t){return{priority:101,require:"ngModel",restrict:"A",compile:function(){var a={maskDefinitions:e.mask,maskResources:{split:/\[\[([^(\[\[)]*)((\|\|)([^(\]\])]*)){0,1}\]\]/g,autoIncrement:/\&/g}};return function(e,n,l,r){function b(e){return angular.isDefined(s)?(z(),o.processed?(P(e),N(),!0):M()):M()}function k(e){angular.isDefined(e)&&(m||(o.placeholder=e),o.processed&&C())}function w(e){return o.processed?(c=L(e||""),p=_(c),r.$setValidity("mask",p),p&&c.length?q(c):void 0):e}function x(e){return o.processed?(c=L(e||""),p=_(c),r.$viewValue=c.length?q(c):"",r.$setValidity("mask",p),""===c&&l.required&&r.$setValidity("required",!1),p?c:void 0):e}function T(e){function r(e,t){var a=0;return e.length>1&&angular.forEach(e,function(e){var n=j(e.value);n.length===t.length&&a++}),a>0}var t;if("string"==typeof e)if(/[^\|]\|[^\|]/.test(e)){o.multiMask=!0,t=[];var a=e.split(""),n="";angular.forEach(a,function(e,t){n+=t>0&&"|"===e&&"|"!==a[t-1]&&"|"!==a[t+1]&&" "!==a[t-1]&&" "!==a[t+1]?" | ":e}),a=n.split(/\ \|\ /),angular.forEach(a,function(e){var n=j(e);r(t,n)||D("split",e)||D("autoIncrement",e)||t.push({value:e.trim(),length:n.length})}),t.length>0?t.sort(function(e,t){return e.length-t.length}):t=""}else{o.multiMask=!1;var l=j(e);t=[{value:e.trim(),length:l.length}]}else o.multiMask=!0,t=[e];return t}function j(e,t){var n,a="";return angular.forEach(E.maskResources,function(t){n=e.match(t)||!1,n="string"!==n?n[0]:n,n=e.split(n).join("")||!1,e=n||e}),e=e.trim(),angular.forEach(e.split(""),function(e){var l=t?!0:E.maskDefinitions[e];l&&(a+=e)}),a.trim()}function O(e){c||(c="");var t=c;e&&(t=e);var n,l,a=t.length;if(S(a)){if("object"==typeof s?angular.forEach(s,function(e,t){0===t?(n=e.value,l=t):a>s[t-1].length&&(n=e.value,l=t)}):n=s,D("split",n)){var f,r=n.match(E.maskResources.split)[0],i=n.split(r),u=j(n).length,d=[];if(a>u){for(var p=1;!f;p++){var m=i[1].substring(p-1,p);if(E.maskDefinitions[m]&&(f=m),!m)return}if(i.length>2){var d=[],g="";angular.forEach(i,function(e,t){0===t?d.push(e):g+=e}),i=d,i.push(g)}r=r.split("[[").join("").split("]]").join("").split("||"),r={delimiter:parseInt(r[0])||!1,divisor:r[1]||!1};var h=[];if(angular.forEach(r.divisor.split(""),function(e){h.push(E.maskDefinitions[e]?"\\"+e:e)}),r.divisor=h.join(""),d[0]=i[0],f&&r.delimiter&&r.delimiter>0)if(r.divisor)for(var p=a-u;p>0;p--)d.push(f),p%r.delimiter===0&&d.push(r.divisor);else for(var p=a-u;p>0;p--)p<r.delimiter&&d.push(f);n=d,n.push(i[1]),n=n.join("")}else n=j(s[l].value,!0)}else if(D("autoIncrement",n)){var d=[],f="",u=j(n).length;if(a>u){d[0]="",d[1]="",d[2]="",angular.forEach(n.split("&"),function(e,t){0===t?d[0]+=e:d[2]+=e}),f=d[2].substring(0,1);for(var p=a-u;p>0;p--)d[1]+=f;n=d.join("")}else n=j(s[l].value,!0)}}else n=o.pattern?o.pattern:"";return n}function S(e){return g&&(parseInt(g)||0)>0?g>=e:!0}function D(e,t){var a;return a=E.maskResources[e].test(t)}function M(){return o.processed=!1,A(),angular.isDefined(m)?n.attr("placeholder",m):n.removeAttr("placeholder"),angular.isDefined(g)?n.attr("maxlength",g):n.removeAttr("maxlength"),n.val(r.$modelValue),r.$viewValue=r.$modelValue,!1}function P(e){if(c=v=L(r.$modelValue||""),d=h=q(c),p=_(c),e)var t=d;else var t=p&&c.length?d:"";l.maxlength&&n.attr("maxlength",2*o.caretMap[o.caretMap.length-1]),(""===m||void 0===m)&&n.attr("placeholder",o.placeholder),n.val(t),r.$viewValue=t}function N(){i||(n.bind("blur",R),n.bind("mousedown mouseup",B),n.bind("input keyup click focus",C),i=!0)}function A(){i&&(n.unbind("blur",R),n.unbind("mousedown",B),n.unbind("mouseup",B),n.unbind("input",C),n.unbind("keyup",C),n.unbind("click",C),n.unbind("focus",C),i=!1)}function _(e){return e.length?e.length>=f:!0}function L(e){var t="",a=o.patterns.slice();for(e=e.toString(),angular.forEach(o.components,function(t){e=e.replace(t,"")});-1!==e.indexOf("_");)e=e.replace("_","");return angular.forEach(e.split(""),function(e){parseInt(a.length)>0&&a[0].test(e)?(t+=e,a.shift()):0!==parseInt(a.length)||a[0]||(t+=e)}),t}function q(e){var t="",a=o.caretMap.slice();return angular.forEach(o.placeholder.split(""),function(n,l){e.length&&l===a[0]?(t+=e.charAt(0)||"_",e=e.substr(1),a.shift()):t+=n}),t}function F(e){var t=l.placeholder;return m?"_":"undefined"!=typeof t&&t[e]?t[e]:"_"}function I(){var e=[];return angular.forEach(o.placeholder.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_"),function(t){t.length<=1?e.push(t):(e.push(t),angular.forEach(t.split(""),function(t){-1===e.indexOf(t)&&e.push(t)}))}),e}function z(){function e(e){var t=0;f=0;var a={caretMap:[],patterns:[],placeholder:"",components:[],multiMask:o.multiMask,processed:!1},n=!1,r=e.split("");angular.forEach(r,function(e,l){E.maskDefinitions[e]&&"\\"!==r[l-1]?(a.caretMap.push(t),a.placeholder+=F(l),a.patterns.push(E.maskDefinitions[e]),t++,n||f++):"?"===e?n=!0:("\\"!==e||"\\"===e&&!E.maskDefinitions[r[l+1]])&&(a.placeholder+=e,t++)}),a.pattern=e,o=a}angular.forEach(o,function(e,t){u[t]=e}),o.caretMap=[],o.patterns=[],o.placeholder="","string"==typeof s&&(s=T(s)),e(O()),o.caretMap.push(o.caretMap.slice().pop()+1),o.components=I(),o.processed=o.caretMap.length>1?!0:!1}function R(){y=0,$=0,p&&0!==c.length||(d="",n.val(""),e.$apply(function(){r.$setViewValue("")}))}function B(e){"mousedown"===e.type?n.bind("mouseout",U):n.unbind("mouseout",U)}function U(){$=G(this),n.unbind("mouseout",U)}function C(t){t=t||{};var a=t.which,l=t.type;if(16!==a&&91!==a){var u,i=n.val(),s=h,f=L(i),c=v,d=!1,p=O(f)!==o.pattern,m=H(this)||0,g=y||0,k=m-g,w=o.caretMap[0],x=o.caretMap[f.length]||o.caretMap.slice().shift(),E=$||0,V=G(this)>0,T=E>0,j=i.length>s.length||E&&i.length>s.length-E,S=i.length<s.length||E&&i.length===s.length-E,D=a>=37&&40>=a&&t.shiftKey,M=37===a,P=8===a||"keyup"!==l&&S&&-1===k,N=46===a||"keyup"!==l&&S&&0===k&&!T,A=(M||P||"click"===l)&&m>w;if($=G(this),!D&&(!V||"click"!==l&&"keyup"!==l)){if(p)return!A&&K(m+1)&&!K(m-1)&&m>0&&!N&&m++,b(!0),y=m,m+=Z(m),u=q(f),f.length>0&&(x=p?u.length:o.caretMap[f.length]),h=u,v=f,n.val(u),e.$apply(function(){r.$setViewValue(f)}),void W(this,m);if("input"===l&&S&&!T&&f===c){for(;P&&m>w&&!K(m);)m--;for(;N&&x>m&&-1===o.caretMap.indexOf(m);)m++;var _=o.caretMap.indexOf(m);f=f.substring(0,_)+f.substring(_+1),d=!0}for(u=q(f),f.length>0&&(x=p?u.length:o.caretMap[f.length]),h=u,v=f,n.val(u),d&&e.$apply(function(){r.$setViewValue(f)}),j&&w>=m&&(m=w+1),A&&-m--,m=m>x?x:w>m?w:m;!K(m)&&m>w&&x>m;)m+=A?-1:1;(A&&x>m||j&&!K(g))&&m++,y=m,W(this,m)}}}function Z(e){var t=0,a=0,n=o.pattern,l=u.pattern;return angular.forEach(n.split(""),function(a,n){o.components.indexOf(a)>-1&&e>n&&t++}),angular.forEach(l.split(""),function(t,n){u.components.indexOf(t)>-1&&e>n&&a++}),t-a}function K(e){return o.caretMap.indexOf(e)>-1}function H(e){if(!e)return 0;if(void 0!==e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var t=document.selection.createRange();return t.moveStart("character",e.value?-e.value.length:0),t.text.length}return 0}function W(e,t){if(!e)return 0;if(0!==e.offsetWidth&&0!==e.offsetHeight)if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,t);else if(e.createTextRange){var a=e.createTextRange();a.collapse(!0),a.moveEnd("character",t),a.moveStart("character",t),a.select()}}function G(e){return e?void 0!==e.selectionStart?e.selectionEnd-e.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var s,f,c,d,p,h,v,y,$,i=!1,o={},u={},m=l.placeholder,g=l.maxlength,E={};l.gOptions?(E=e.$eval("["+l.gOptions+"]"),angular.isObject(E[0])&&(E=function(e,t){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]?angular.extend(t[a],e[a]):t[a]=angular.copy(e[a]));return t}(a,E[0]))):E=a,l.$observe("grMaskPattern",function(e){if(s=e,b(),l.grValue){if(c=L(l.grValue),c.length<j(o.pattern).length)return void(c="");b(!0)}}),l.$observe("placeholder",k);var V=!1;l.$observe("modelViewValue",function(e){"true"===e&&(V=!0)}),e.$watch(l.ngModel,function(a){if(V&&a){var n=t(l.ngModel);n.assign(e,r.$viewValue)}}),r.$formatters.push(w),r.$parsers.push(x),n.bind("mousedown mouseup",B),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null===this)throw new TypeError;var t=Object(this),a=t.length>>>0;if(0===a)return-1;var n=0;if(arguments.length>1&&(n=Number(arguments[1]),n!==n?n=0:0!==n&&1/0!==n&&n!==-1/0&&(n=(n>0||-1)*Math.floor(Math.abs(n)))),n>=a)return-1;for(var l=n>=0?n:Math.max(a-Math.abs(n),0);a>l;l++)if(l in t&&t[l]===e)return l;return-1})}}}}]);
