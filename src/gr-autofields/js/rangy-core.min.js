!function(e,t){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e():t.rangy=e()}(function(){function s(n,r){var a=typeof n[r];return a==t||!(a!=e||!n[r])||"unknown"==a}function f(t,n){return!(typeof t[n]!=e||!t[n])}function c(e,t){return typeof e[t]!=n}function l(e){return function(t,n){for(var r=n.length;r--;)if(!e(t,n[r]))return!1;return!0}}function g(e){return e&&d(e,i)&&h(e,o)}function v(e){return f(e,"body")?e.body:e.getElementsByTagName("body")[0]}function E(e){typeof console!=n&&s(console,"log")&&console.log(e)}function S(e,t){R&&t?alert(e):E(e)}function w(e){N.initialized=!0,N.supported=!1,S("Rangy is not supported in this environment. Reason: "+e,N.config.alertOnFail)}function y(e){S("Rangy warning: "+e,N.config.alertOnWarn)}function D(e){return e.message||e.description||String(e)}function x(){if(R&&!N.initialized){var e,t=!1,n=!1;s(document,"createRange")&&(e=document.createRange(),d(e,a)&&h(e,r)&&(t=!0));var o=v(document);if(!o||"body"!=o.nodeName.toLowerCase())return void w("No body element found");if(o&&s(o,"createTextRange")&&(e=o.createTextRange(),g(e)&&(n=!0)),!t&&!n)return void w("Neither Range nor TextRange are available");N.initialized=!0,N.features={implementsDomRange:t,implementsTextRange:n};var i,f;for(var c in m)(i=m[c])instanceof b&&i.init(i,N);for(var l=0,u=_.length;u>l;++l)try{_[l](N)}catch(p){f="Rangy init listener threw an exception. Continuing. Detail: "+D(p),E(f)}}}function I(e){e=e||window,x();for(var t=0,n=A.length;n>t;++t)A[t](e)}function b(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function P(e,t,n){var r=new b(e,t,function(t){if(!t.initialized){t.initialized=!0;try{n(N,t),t.supported=!0}catch(r){var a="Module '"+e+"' failed to load: "+D(r);E(a),r.stack&&E(r.stack)}}});return m[e]=r,r}function B(){}function M(){}var e="object",t="function",n="undefined",r=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],a=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],o=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],i=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],d=l(s),u=l(f),h=l(c),p=[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,r=e.length;r>n;++n)t(e[n],n)},m={},R=typeof window!=n&&typeof document!=n,C={isHostMethod:s,isHostObject:f,isHostProperty:c,areHostMethods:d,areHostObjects:u,areHostProperties:h,isTextRange:g,getBody:v,forEach:p},N={version:"1.3.0-alpha.20150122",initialized:!1,isBrowser:R,supported:!0,util:C,features:{},modules:m,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==n?!0:rangyAutoInitialize}};N.fail=w,N.warn=y;var T;({}).hasOwnProperty?(C.extend=T=function(e,t,n){var r,a;for(var o in t)t.hasOwnProperty(o)&&(r=e[o],a=t[o],n&&null!==r&&"object"==typeof r&&null!==a&&"object"==typeof a&&T(r,a,!0),e[o]=a);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},C.createOptions=function(e,t){var n={};return T(n,t),e&&T(n,e),n}):w("hasOwnProperty not supported"),R||w("Rangy can only run in a browser"),function(){var e;if(R){var t=document.createElement("div");t.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(t.childNodes,0)[0].nodeType&&(e=function(e){return n.call(e,0)})}catch(r){}}e||(e=function(e){for(var t=[],n=0,r=e.length;r>n;++n)t[n]=e[n];return t}),C.toArray=e}();var O;R&&(s(document,"addEventListener")?O=function(e,t,n){e.addEventListener(t,n,!1)}:s(document,"attachEvent")?O=function(e,t,n){e.attachEvent("on"+t,n)}:w("Document does not have required addEventListener or attachEvent method"),C.addListener=O);var _=[];N.init=x,N.addInitListener=function(e){N.initialized?e(N):_.push(e)};var A=[];N.addShimListener=function(e){A.push(e)},R&&(N.shim=N.createMissingNativeApi=I),b.prototype={init:function(){for(var r,a,e=this.dependencies||[],t=0,n=e.length;n>t;++t){if(a=e[t],r=m[a],!(r&&r instanceof b))throw new Error("required module '"+a+"' not found");if(r.init(),!r.supported)throw new Error("required module '"+a+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){N.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){N.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},N.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]);var r=P(e,n,t);N.initialized&&N.supported&&r.init()},N.createCoreModule=function(e,t,n){P(e,t,n)},N.RangePrototype=B,N.rangePrototype=new B,N.selectionPrototype=new M,N.createCoreModule("DomUtil",[],function(e,t){function s(e){var t;return typeof e.namespaceURI==n||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function f(e){var t=e.parentNode;return 1==t.nodeType?t:null}function c(e){for(var t=0;e=e.previousSibling;)++t;return t}function l(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function d(e,t){var r,n=[];for(r=e;r;r=r.parentNode)n.push(r);for(r=t;r;r=r.parentNode)if(i(n,r))return r;return null}function u(e,t,n){for(var r=n?t:t.parentNode;r;){if(r===e)return!0;r=r.parentNode}return!1}function h(e,t){return u(e,t,!0)}function g(e,t,n){for(var r,a=n?e:e.parentNode;a;){if(r=a.parentNode,r===t)return a;a=r}return null}function v(e){var t=e.nodeType;return 3==t||4==t||8==t}function p(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function m(e,t){var n=t.nextSibling,r=t.parentNode;return n?r.insertBefore(e,n):r.appendChild(e),e}function R(e,t,n){var r=e.cloneNode(!1);if(r.deleteData(0,t),e.deleteData(t,e.length-t),m(r,e),n)for(var o,a=0;o=n[a++];)o.node==e&&o.offset>t?(o.node=r,o.offset-=t):o.node==e.parentNode&&o.offset>c(e)&&++o.offset;return r}function C(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=n)return e.ownerDocument;if(typeof e.document!=n)return e.document;if(e.parentNode)return C(e.parentNode);throw t.createError("getDocument: no document found for node")}function N(e){var r=C(e);if(typeof r.defaultView!=n)return r.defaultView;if(typeof r.parentWindow!=n)return r.parentWindow;throw t.createError("Cannot get a window object for node")}function E(e){if(typeof e.contentDocument!=n)return e.contentDocument;if(typeof e.contentWindow!=n)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function S(e){if(typeof e.contentWindow!=n)return e.contentWindow;if(typeof e.contentDocument!=n)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function w(e){return e&&r.isHostMethod(e,"setTimeout")&&r.isHostObject(e,"document")}function y(e,t,n){var a;if(e?r.isHostProperty(e,"nodeType")?a=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?E(e):C(e):w(e)&&(a=e.document):a=document,!a)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return a}function T(e){for(var t;t=e.parentNode;)e=t;return e}function O(e,n,r,a){var o,i,s,f,l;if(e==r)return n===a?0:a>n?-1:1;if(o=g(r,e,!0))return n<=c(o)?-1:1;if(o=g(e,r,!0))return c(o)<a?-1:1;if(i=d(e,r),!i)throw new Error("comparePoints error: nodes have no common ancestor");if(s=e===i?i:g(e,i,!0),f=r===i?i:g(r,i,!0),s===f)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(l=i.firstChild;l;){if(l===s)return-1;if(l===f)return 1;l=l.nextSibling}}function D(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function x(e){if(!e)return"[No node]";if(_&&D(e))return"[Broken node]";if(v(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+c(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function A(e){for(var n,t=C(e).createDocumentFragment();n=e.firstChild;)t.appendChild(n);return t}function b(e){this.root=e,this._next=e}function P(e){return new b(e)}function B(e,t){this.node=e,this.offset=t}function M(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var n="undefined",r=e.util;r.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),r.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var a=document.createElement("div");r.areHostMethods(a,["insertBefore","appendChild","cloneNode"]||!r.areHostObjects(a,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),r.isHostProperty(a,"innerHTML")||t.fail("Element is missing innerHTML property");var o=document.createTextNode("test");r.areHostMethods(o,["splitText","deleteData","insertData","appendData","cloneNode"]||!r.areHostObjects(a,["previousSibling","nextSibling","childNodes","parentNode"])||!r.areHostProperties(o,["data"]))||t.fail("Incomplete Text Node implementation");var i=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},_=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br />",_=D(n),e.features.crashyTextNodes=_}();var I;typeof window.getComputedStyle!=n?I=function(e,t){return N(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=n?I=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),b.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var t,n,e=this._current=this._next;if(this._current)if(t=e.firstChild)this._next=t;else{for(n=null;e!==this.root&&!(n=e.nextSibling);)e=e.parentNode;this._next=n}return this._current},detach:function(){this._current=this._next=this.root=null}},B.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},M.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},M.prototype.toString=function(){return this.message},e.dom={arrayContains:i,isHtmlNamespace:s,parentElement:f,getNodeIndex:c,getNodeLength:l,getCommonAncestor:d,isAncestorOf:u,isOrIsAncestorOf:h,getClosestAncestorIn:g,isCharacterDataNode:v,isTextOrCommentNode:p,insertAfter:m,splitDataNode:R,getDocument:C,getWindow:N,getIframeWindow:S,getIframeDocument:E,getBody:r.getBody,isWindow:w,getContentDocument:y,getRootContainer:T,comparePoints:O,isBrokenNode:D,inspectNode:x,getComputedStyleProperty:I,fragmentFromNodeChildren:A,createIterator:P,DomPosition:B},e.DOMException=M}),N.createCoreModule("DomRange",["DomUtil"],function(e){function m(e,t){return 3!=e.nodeType&&(f(e,t.startContainer)||f(e,t.endContainer))}function R(e){return e.document||c(e.startContainer)}function C(e){return new a(e.parentNode,s(e))}function N(e){return new a(e.parentNode,s(e)+1)}function E(e,t,r){var a=11==e.nodeType?e.firstChild:e;return i(t)?r==t.length?n.insertAfter(e,t):t.parentNode.insertBefore(e,0==r?t:d(t,r)):r>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[r]),a}function S(e,t,n){if(G(e),G(t),R(t)!=R(e))throw new o("WRONG_DOCUMENT_ERR");var r=l(e.startContainer,e.startOffset,t.endContainer,t.endOffset),a=l(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return n?0>=r&&a>=0:0>r&&a>0}function w(e){for(var t,n,a,r=R(e.range).createDocumentFragment();n=e.next();){if(t=e.isPartiallySelectedSubtree(),n=n.cloneNode(!t),t&&(a=e.getSubtreeIterator(),n.appendChild(w(a)),a.detach()),10==n.nodeType)throw new o("HIERARCHY_REQUEST_ERR");r.appendChild(n)}return r}function y(e,t,r){var a,o;r=r||{stop:!1};for(var i,s;i=e.next();)if(e.isPartiallySelectedSubtree()){if(t(i)===!1)return void(r.stop=!0);if(s=e.getSubtreeIterator(),y(s,t,r),s.detach(),r.stop)return}else for(a=n.createIterator(i);o=a.next();)if(t(o)===!1)return void(r.stop=!0)}function T(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),T(t),t.detach()):e.remove()}function O(e){for(var t,r,n=R(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),r=e.getSubtreeIterator(),t.appendChild(O(r)),r.detach()):e.remove(),10==t.nodeType)throw new o("HIERARCHY_REQUEST_ERR");n.appendChild(t)}return n}function _(e,t,n){var a,r=!(!t||!t.length),o=!!n;r&&(a=new RegExp("^("+t.join("|")+")$"));var s=[];return y(new x(e,!1),function(t){if(!(r&&!a.test(t.nodeType)||o&&!n(t))){var f=e.startContainer;if(t!=f||!i(f)||e.startOffset!=f.length){var c=e.endContainer;t==c&&i(c)&&0==e.endOffset||s.push(t)}}}),s}function D(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+n.inspectNode(e.startContainer)+":"+e.startOffset+", "+n.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function x(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&i(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||i(this.sc)?u(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||i(this.ec)?u(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function M(e){return function(t,n){for(var r,a=n?t:t.parentNode;a;){if(r=a.nodeType,g(e,r))return a;a=a.parentNode}return null}}function L(e,t){if(W(e,t))throw new o("INVALID_NODE_TYPE_ERR")}function F(e,t){if(!g(t,e.nodeType))throw new o("INVALID_NODE_TYPE_ERR")}function j(e,t){if(0>t||t>(i(e)?e.length:e.childNodes.length))throw new o("INDEX_SIZE_ERR")}function z(e,t){if(H(e,!0)!==H(t,!0))throw new o("WRONG_DOCUMENT_ERR")}function U(e){if(k(e,!0))throw new o("NO_MODIFICATION_ALLOWED_ERR")}function V(e,t){if(!e)throw new o(t)}function q(e){return p&&n.isBrokenNode(e)||!g(I,e.nodeType)&&!H(e,!0)}function Y(e,t){return t<=(i(e)?e.length:e.childNodes.length)}function Q(e){return!!e.startContainer&&!!e.endContainer&&!q(e.startContainer)&&!q(e.endContainer)&&Y(e.startContainer,e.startOffset)&&Y(e.endContainer,e.endOffset)}function G(e){if(!Q(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function K(e,t){G(e);var n=e.startContainer,r=e.startOffset,a=e.endContainer,o=e.endOffset,f=n===a;i(a)&&o>0&&o<a.length&&d(a,o,t),i(n)&&r>0&&r<n.length&&(n=d(n,r,t),f?(o-=r,a=n):a==n.parentNode&&o>=s(n)&&o++,r=0),e.setStartAndEnd(n,r,a,o)}function et(e){G(e);var t=e.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(e.cloneContents()),t.innerHTML}function lt(e){e.START_TO_START=nt,e.START_TO_END=rt,e.END_TO_END=at,e.END_TO_START=ot,e.NODE_BEFORE=it,e.NODE_AFTER=st,e.NODE_BEFORE_AND_AFTER=ft,e.NODE_INSIDE=ct}function dt(e){lt(e),lt(e.prototype)}function ut(e,t){return function(){G(this);var i,s,n=this.startContainer,r=this.startOffset,a=this.commonAncestorContainer,o=new x(this,!0);n!==a&&(i=u(n,a,!0),s=N(i),n=s.node,r=s.offset),y(o,U),o.reset();var f=e(o);return o.detach(),t(this,n,r,n,r),f}}function ht(t,n){function a(e,t){return function(n){F(n,A),F(v(n),I);var r=(e?C:N)(n);(t?o:f)(this,r.node,r.offset)}}function o(e,t,r){var a=e.endContainer,o=e.endOffset;(t!==e.startContainer||r!==e.startOffset)&&((v(t)!=v(a)||1==l(t,r,a,o))&&(a=t,o=r),n(e,t,r,a,o))}function f(e,t,r){var a=e.startContainer,o=e.startOffset;(t!==e.endContainer||r!==e.endOffset)&&((v(t)!=v(a)||-1==l(t,r,a,o))&&(a=t,o=r),n(e,a,o,t,r))}var c=function(){};c.prototype=e.rangePrototype,t.prototype=new c,r.extend(t.prototype,{setStart:function(e,t){L(e,!0),j(e,t),o(this,e,t)},setEnd:function(e,t){L(e,!0),j(e,t),f(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],r=e[1],a=t,o=r;switch(e.length){case 3:o=e[2];break;case 4:a=e[2],o=e[3]}n(this,t,r,a,o)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){G(this),e?n(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):n(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){L(e,!0),n(this,e,0,e,h(e))},selectNode:function(e){L(e,!1),F(e,A);var t=C(e),r=N(e);n(this,t.node,t.offset,r.node,r.offset)},extractContents:ut(O,n),deleteContents:ut(T,n),canSurroundContents:function(){G(this),U(this.startContainer),U(this.endContainer);var e=new x(this,!0),t=e._first&&m(e._first,this)||e._last&&m(e._last,this);return e.detach(),!t},splitBoundaries:function(){K(this)},splitBoundariesPreservingPositions:function(e){K(this,e)},normalizeBoundaries:function(){G(this);var e=this.startContainer,t=this.startOffset,r=this.endContainer,a=this.endOffset,o=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(r=e,a=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},f=function(n){var o=n.previousSibling;if(o&&o.nodeType==n.nodeType){e=n;var i=n.length;if(t=o.length,n.insertData(0,o.data),o.parentNode.removeChild(o),e==r)a+=t,r=e;else if(r==n.parentNode){var f=s(n);a==f?(r=n,a=i):a>f&&a--}}},c=!0;if(i(r))r.length==a&&o(r);else{if(a>0){var l=r.childNodes[a-1];l&&i(l)&&o(l)}c=!this.collapsed}if(c){if(i(e))0==t&&f(e);else if(t<e.childNodes.length){var d=e.childNodes[t];d&&i(d)&&f(d)}}else e=r,t=a;n(this,e,t,r,a)},collapseToPoint:function(e,t){L(e,!0),j(e,t),this.setStartAndEnd(e,t)}}),dt(t)}function gt(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:n.getCommonAncestor(e.startContainer,e.endContainer)}function vt(e,t,r,a,o){e.startContainer=t,e.startOffset=r,e.endContainer=a,e.endOffset=o,e.document=n.getDocument(t),gt(e)}function pt(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,gt(this)}var n=e.dom,r=e.util,a=n.DomPosition,o=e.DOMException,i=n.isCharacterDataNode,s=n.getNodeIndex,f=n.isOrIsAncestorOf,c=n.getDocument,l=n.comparePoints,d=n.splitDataNode,u=n.getClosestAncestorIn,h=n.getNodeLength,g=n.arrayContains,v=n.getRootContainer,p=e.features.crashyTextNodes;x.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,i(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var t,n,e=this._current;!i(e)||e!==this.sc&&e!==this.ec?e.parentNode&&e.parentNode.removeChild(e):(t=e===this.sc?this.so:0,n=e===this.ec?this.eo:e.length,t!=n&&e.deleteData(t,n-t))},isPartiallySelectedSubtree:function(){var e=this._current;return m(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new pt(R(this.range));var t=this._current,n=t,r=0,a=t,o=h(t);f(t,this.sc)&&(n=this.sc,r=this.so),f(t,this.ec)&&(a=this.ec,o=this.eo),vt(e,n,r,a,o)}return new x(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var A=[1,3,4,5,7,8,10],I=[2,9,11],b=[5,6,10,12],P=[1,3,4,5,7,8,10,11],B=[1,3,4,5,7,8],H=M([9,11]),k=M(b),W=M([6,10,12]),X=document.createElement("style"),Z=!1;try{X.innerHTML="<b>x</b>",Z=3==X.firstChild.nodeType}catch($){}e.features.htmlParsingConforms=Z;var J=Z?function(e){var t=this.startContainer,r=c(t);if(!t)throw new o("INVALID_STATE_ERR");var a=null;return 1==t.nodeType?a=t:i(t)&&(a=n.parentElement(t)),a=null===a||"HTML"==a.nodeName&&n.isHtmlNamespace(c(a).documentElement)&&n.isHtmlNamespace(a)?r.createElement("body"):a.cloneNode(!1),a.innerHTML=e,n.fragmentFromNodeChildren(a)}:function(e){var t=R(this),r=t.createElement("body");return r.innerHTML=e,n.fragmentFromNodeChildren(r)},tt=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],nt=0,rt=1,at=2,ot=3,it=0,st=1,ft=2,ct=3;r.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){G(this),z(this.startContainer,t.startContainer);var n,r,a,o,i=e==ot||e==nt?"start":"end",s=e==rt||e==nt?"start":"end";return n=this[i+"Container"],r=this[i+"Offset"],a=t[s+"Container"],o=t[s+"Offset"],l(n,r,a,o)},insertNode:function(e){if(G(this),F(e,P),U(this.startContainer),f(e,this.startContainer))throw new o("HIERARCHY_REQUEST_ERR");var t=E(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){G(this);var e,t;if(this.collapsed)return R(this).createDocumentFragment();if(this.startContainer===this.endContainer&&i(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=R(this).createDocumentFragment(),t.appendChild(e),t;var n=new x(this,!0);return e=w(n),n.detach(),e},canSurroundContents:function(){G(this),U(this.startContainer),U(this.endContainer);var e=new x(this,!0),t=e._first&&m(e._first,this)||e._last&&m(e._last,this);return e.detach(),!t},surroundContents:function(e){if(F(e,B),!this.canSurroundContents())throw new o("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);E(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){G(this);for(var n,e=new pt(R(this)),t=tt.length;t--;)n=tt[t],e[n]=this[n];return e},toString:function(){G(this);var e=this.startContainer;if(e===this.endContainer&&i(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new x(this,!0);return y(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){G(this);var t=e.parentNode,n=s(e);if(!t)throw new o("NOT_FOUND_ERR");var r=this.comparePoint(t,n),a=this.comparePoint(t,n+1);return 0>r?a>0?ft:it:a>0?st:ct},comparePoint:function(e,t){return G(this),V(e,"HIERARCHY_REQUEST_ERR"),z(e,this.startContainer),l(e,t,this.startContainer,this.startOffset)<0?-1:l(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:J,toHtml:function(){return et(this)},intersectsNode:function(e,t){if(G(this),V(e,"NOT_FOUND_ERR"),c(e)!==R(this))return!1;var n=e.parentNode,r=s(e);V(n,"NOT_FOUND_ERR");var a=l(n,r,this.endContainer,this.endOffset),o=l(n,r+1,this.startContainer,this.startOffset);return t?0>=a&&o>=0:0>a&&o>0},isPointInRange:function(e,t){return G(this),V(e,"HIERARCHY_REQUEST_ERR"),z(e,this.startContainer),l(e,t,this.startContainer,this.startOffset)>=0&&l(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return S(this,e,!1)},intersectsOrTouchesRange:function(e){return S(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=l(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=l(this.endContainer,this.endOffset,e.endContainer,e.endOffset),r=this.cloneRange();return-1==t&&r.setStart(e.startContainer,e.startOffset),1==n&&r.setEnd(e.endContainer,e.endOffset),r}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==l(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==l(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new o("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==ct},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,h(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var r=n.pop();return t.setEnd(r,r.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return G(this),_(this,e,t)},getDocument:function(){return R(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var r=R(this),a=e.createRange(r);t=t||n.getBody(r),a.selectNodeContents(t);var o=this.intersection(a),i=0,s=0;return o&&(a.setEnd(o.startContainer,o.startOffset),i=a.toString().length,s=i+o.toString().length),{start:i,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var a,s,f,c,r=[t],o=!1,i=!1;!i&&(a=r.pop());)if(3==a.nodeType)s=n+a.length,!o&&e.start>=n&&e.start<=s&&(this.setStart(a,e.start-n),o=!0),o&&e.end>=n&&e.end<=s&&(this.setEnd(a,e.end-n),i=!0),n=s;else for(c=a.childNodes,f=c.length;f--;)r.push(c[f])},getName:function(){return"DomRange"},equals:function(e){return pt.rangesEqual(this,e)},isValid:function(){return Q(this)},inspect:function(){return D(this)},detach:function(){}}),ht(pt,vt),r.extend(pt,{rangeProperties:tt,RangeIterator:x,copyComparisonConstants:dt,createPrototypeRange:ht,inspect:D,toHtml:et,getRangeDocument:R,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=pt}),N.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,r,a=e.dom,o=e.util,i=a.DomPosition,s=e.DomRange,f=a.getBody,c=a.getContentDocument,l=a.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function l(e){for(var n,t=i.length;t--;)n=i[t],e[n]=e.nativeRange[n];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function d(e,t,n,r,a){var o=e.startContainer!==t||e.startOffset!=n,i=e.endContainer!==r||e.endOffset!=a,s=!e.equals(e.nativeRange);(o||i||s)&&(e.setEnd(r,a),e.setStart(t,n))}var r,u,i=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,l(this)},s.createPrototypeRange(n,d),r=n.prototype,r.selectNode=function(e){this.nativeRange.selectNode(e),l(this)},r.cloneContents=function(){return this.nativeRange.cloneContents()},r.surroundContents=function(e){this.nativeRange.surroundContents(e),l(this)},r.collapse=function(e){this.nativeRange.collapse(e),l(this)},r.cloneRange=function(){return new n(this.nativeRange.cloneRange())},r.refresh=function(){l(this)},r.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");f(document).appendChild(h);var g=document.createRange();g.setStart(h,0),g.setEnd(h,0);try{g.setStart(h,1),r.setStart=function(e,t){this.nativeRange.setStart(e,t),l(this)},r.setEnd=function(e,t){this.nativeRange.setEnd(e,t),l(this)},u=function(e){return function(t){this.nativeRange[e](t),l(this)}}}catch(v){r.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}l(this)},r.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}l(this)},u=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}l(this)}}}r.setStartBefore=u("setStartBefore","setEndBefore"),r.setStartAfter=u("setStartAfter","setEndAfter"),r.setEndBefore=u("setEndBefore","setStartBefore"),r.setEndAfter=u("setEndAfter","setStartAfter"),r.selectNodeContents=function(e){this.setStartAndEnd(e,0,a.getNodeLength(e))},g.selectNodeContents(h),g.setEnd(h,3);var p=document.createRange();p.selectNodeContents(h),p.setEnd(h,4),p.setStart(h,2),r.compareBoundaryPoints=-1==g.compareBoundaryPoints(g.START_TO_END,p)&&1==g.compareBoundaryPoints(g.END_TO_START,p)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var m=document.createElement("div");m.innerHTML="123";var R=m.firstChild,C=f(document);C.appendChild(m),g.setStart(R,1),g.setEnd(R,2),g.deleteContents(),"13"==R.data&&(r.deleteContents=function(){this.nativeRange.deleteContents(),l(this)},r.extractContents=function(){var e=this.nativeRange.extractContents();return l(this),e}),C.removeChild(m),C=null,o.isHostMethod(g,"createContextualFragment")&&(r.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),f(document).removeChild(h),r.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var d=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var r=n.parentElement();n=e.duplicate(),n.collapse(!1);var o=n.parentElement(),i=r==o?r:a.getCommonAncestor(r,o);return i==t?i:a.getCommonAncestor(t,i)},u=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,r,o){var s=e.duplicate();s.collapse(n);var f=s.parentElement();if(a.isOrIsAncestorOf(t,f)||(f=t),!f.canHaveHTML){var c=new i(f.parentNode,a.getNodeIndex(f));return{boundaryPosition:c,nodeInfo:{nodeIndex:c.offset,containerElement:c.node}}}var d=a.getDocument(f).createElement("span");d.parentNode&&d.parentNode.removeChild(d);for(var u,g,v,p,m,h=n?"StartToStart":"StartToEnd",R=o&&o.containerElement==f?o.nodeIndex:0,C=f.childNodes.length,N=C,E=N;;){if(E==C?f.appendChild(d):f.insertBefore(d,f.childNodes[E]),s.moveToElementText(d),u=s.compareEndPoints(h,e),0==u||R==N)break;if(-1==u){if(N==R+1)break;R=E}else N=N==R+1?R:E;E=Math.floor((R+N)/2),f.removeChild(d)}if(m=d.nextSibling,-1==u&&m&&l(m)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var S;if(/[\r\n]/.test(m.data)){var w=s.duplicate(),y=w.text.replace(/\r\n/g,"\r").length;for(S=w.moveStart("character",y);-1==(u=w.compareEndPoints("StartToEnd",w));)S++,w.moveStart("character",1)}else S=s.text.length;p=new i(m,S)}else g=(r||!n)&&d.previousSibling,v=(r||n)&&d.nextSibling,p=v&&l(v)?new i(v,0):g&&l(g)?new i(g,g.data.length):new i(f,a.getNodeIndex(d));return d.parentNode.removeChild(d),{boundaryPosition:p,nodeInfo:{nodeIndex:E,containerElement:f}}},g=function(e,t){var n,r,s,c,o=e.offset,i=a.getDocument(e.node),d=f(i).createTextRange(),u=l(e.node);return u?(n=e.node,r=n.parentNode):(c=e.node.childNodes,n=o<c.length?c[o]:null,r=e.node),s=i.createElement("span"),s.innerHTML="&#feff;",n?r.insertBefore(s,n):r.appendChild(s),d.moveToElementText(s),d.collapse(!t),r.removeChild(s),u&&d[t?"moveStart":"moveEnd"]("character",o),d};r=function(e){this.textRange=e,this.refresh()},r.prototype=new s(document),r.prototype.refresh=function(){var e,t,n,r=d(this.textRange);u(this.textRange)?t=e=h(this.textRange,r,!0,!0).boundaryPosition:(n=h(this.textRange,r,!0,!1),e=n.boundaryPosition,t=h(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},r.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(r);var v=function(e){if(e.collapsed)return g(new i(e.startContainer,e.startOffset),!0);var t=g(new i(e.startContainer,e.startOffset),!0),n=g(new i(e.endContainer,e.endOffset),!1),r=f(s.getRangeDocument(e)).createTextRange();return r.setEndPoint("StartToStart",t),r.setEndPoint("EndToEnd",n),r};if(r.rangeToTextRange=v,r.prototype.toTextRange=function(){return v(this)
},e.WrappedTextRange=r,!e.features.implementsDomRange||e.config.preferTextRange){var p=function(e){return e("return this;")()}(Function);"undefined"==typeof p.Range&&(p.Range=r),e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),f(e).createTextRange()},e.WrappedRange=r}}e.createRange=function(n){return n=c(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=c(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addShimListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),N.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function R(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function C(e,n){if(e){if(a.isWindow(e))return e;if(e instanceof G)return e.win;var r=a.getContentDocument(e,t,n);return a.getWindow(r)}return window}function N(e){return C(e,"getWinSelection").getSelection()}function E(e){return C(e,"getDocSelection").document.selection}function S(e){var t=!1;return e.anchorNode&&(t=1==a.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function k(e,t,n){var r=n?"end":"start",a=n?"start":"end";e.anchorNode=t[r+"Container"],e.anchorOffset=t[r+"Offset"],e.focusNode=t[a+"Container"],e.focusOffset=t[a+"Offset"]}function W(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function L(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function F(t){var n;return t instanceof s?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof f?n=t.nativeRange:h.implementsDomRange&&t instanceof a.getWindow(t.startContainer).Range&&(n=t),n}function j(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!a.isAncestorOf(e[0],e[t]))return!1;return!0}function z(e){var n=e.getNodes();if(!j(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function U(e){return!!e&&"undefined"!=typeof e.text}function V(e,t){var n=new f(t);e._ranges=[n],k(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function q(t){if(t._ranges.length=0,"None"==t.docSelection.type)L(t);else{var n=t.docSelection.createRange();if(U(n))V(t,n);else{t.rangeCount=n.length;for(var r,a=v(n.item(0)),o=0;o<t.rangeCount;++o)r=e.createRange(a),r.selectNode(n.item(o)),t._ranges.push(r);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,k(t,t._ranges[t.rangeCount-1],!1)}}}function Y(e,n){for(var r=e.docSelection.createRange(),a=z(n),o=v(r.item(0)),i=p(o).createControlRange(),s=0,f=r.length;f>s;++s)i.add(r.item(s));try{i.add(a)}catch(c){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}i.select(),q(e)}function G(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function X(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function $(e,t){for(var r,a,n=Z.length;n--;)if(r=Z[n],a=r.selection,"deleteAll"==t)X(a);else if(r.win==e)return"delete"==t?(Z.splice(n,1),!0):a;return"deleteAll"==t&&(Z.length=0),null}function et(e,n){for(var i,r=v(n[0].startContainer),a=p(r).createControlRange(),o=0,s=n.length;s>o;++o){i=z(n[o]);try{a.add(i)}catch(f){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}a.select(),q(e)}function ot(e,t){if(e.win.document!=v(t))throw new c("WRONG_DOCUMENT_ERR")}function it(t){return function(n,r){var a;this.rangeCount?(a=this.getRangeAt(0),a["set"+(t?"Start":"End")](n,r)):(a=e.createRange(this.win.document),a.setStartAndEnd(n,r)),this.setSingleRange(a,this.isBackward())}}function st(e){var t=[],n=new l(e.anchorNode,e.anchorOffset),r=new l(e.focusNode,e.focusOffset),a="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var o=0,i=e.rangeCount;i>o;++o)t[o]=s.inspect(e.getRangeAt(o));return"["+a+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+r.inspect()+"]"}e.config.checkSelectionRanges=!0;var d,u,n="boolean",r="number",a=e.dom,o=e.util,i=o.isHostMethod,s=e.DomRange,f=e.WrappedRange,c=e.DOMException,l=a.DomPosition,h=e.features,g="Control",v=a.getDocument,p=a.getBody,m=s.rangesEqual,w=i(window,"getSelection"),y=o.isHostObject(document,"selection");h.implementsWinGetSelection=w,h.implementsDocSelection=y;var T=y&&(!w||e.config.preferTextRange);T?(d=E,e.isSelectionValid=function(e){var t=C(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||v(n.createRange().parentElement())==t}):w?(d=N,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=d;var O=d(),_=e.createNativeRange(document),D=p(document),x=o.areHostProperties(O,["anchorNode","focusNode","anchorOffset","focusOffset"]);h.selectionHasAnchorAndFocus=x;var A=i(O,"extend");h.selectionHasExtend=A;var I=typeof O.rangeCount==r;h.selectionHasRangeCount=I;var b=!1,P=!0,B=A?function(t,n){var r=s.getRangeDocument(n),a=e.createRange(r);a.collapseToPoint(n.endContainer,n.endOffset),t.addRange(F(a)),t.extend(n.startContainer,n.startOffset)}:null;o.areHostMethods(O,["addRange","getRangeAt","removeAllRanges"])&&typeof O.rangeCount==r&&h.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,r=n>1,a=[],o=S(t),i=0;n>i;++i)a[i]=t.getRangeAt(i);var s=p(document),f=s.appendChild(document.createElement("div"));f.contentEditable="false";var c=f.appendChild(document.createTextNode("   ")),l=document.createRange();if(l.setStart(c,1),l.collapse(!0),t.addRange(l),P=1==t.rangeCount,t.removeAllRanges(),!r){var d=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(d&&parseInt(d[1])>=36)b=!1;else{var u=l.cloneRange();l.setStart(c,0),u.setEnd(c,3),u.setStart(c,2),t.addRange(l),t.addRange(u),b=2==t.rangeCount}}for(s.removeChild(f),t.removeAllRanges(),i=0;n>i;++i)0==i&&o?B?B(t,a[i]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(a[i])):t.addRange(a[i])}}(),h.selectionSupportsMultipleRanges=b,h.collapsedNonEditableSelectionsSupported=P;var H,M=!1;D&&i(D,"createControlRange")&&(H=D.createControlRange(),o.areHostProperties(H,["item","add"])&&(M=!0)),h.implementsControlRange=M,u=x?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var Q;i(O,"getRangeAt")?Q=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:x&&(Q=function(t){var n=v(t.anchorNode),r=e.createRange(n);return r.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),r.collapsed!==this.isCollapsed&&r.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),r}),G.prototype=e.selectionPrototype;var Z=[],J=function(e){if(e&&e instanceof G)return e.refresh(),e;e=C(e,"getNativeSelection");var t=$(e),n=d(e),r=y?E(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new G(n,r,e),Z.push({win:e,selection:t})),t};e.getSelection=J,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(a.getIframeWindow(n))};var K=G.prototype;if(!T&&x&&o.areHostMethods(O,["removeAllRanges","addRange"])){K.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),L(this)};var tt=function(e,t){B(e.nativeSelection,t),e.refresh()};K.addRange=I?function(t,n){if(M&&y&&this.docSelection.type==g)Y(this,t);else if(R(n)&&A)tt(this,t);else{var r;b?r=this.rangeCount:(this.removeAllRanges(),r=0);var a=F(t).cloneRange();try{this.nativeSelection.addRange(a)}catch(o){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var i=Q(this.nativeSelection,this.rangeCount-1);i&&!m(i,t)&&(t=new f(i))}this._ranges[this.rangeCount-1]=t,k(this,t,at(this.nativeSelection)),this.isCollapsed=u(this)}else this.refresh()}}:function(e,t){R(t)&&A?tt(this,e):(this.nativeSelection.addRange(F(e)),this.refresh())},K.setRanges=function(e){if(M&&y&&e.length>1)et(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(i(O,"empty")&&i(_,"select")&&M&&T))return t.fail("No means of selecting a Range or TextRange was found"),!1;K.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=v(this.anchorNode);else if(this.docSelection.type==g){var t=this.docSelection.createRange();t.length&&(e=v(t.item(0)))}if(e){var n=p(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(r){}L(this)},K.addRange=function(t){this.docSelection.type==g?Y(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,k(this,t,!1))},K.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?et(this,e):t&&this.addRange(e[0])}}K.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new c("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var nt;if(T)nt=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=p(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==g?q(t):U(n)?V(t,n):L(t)};else if(i(O,"getRangeAt")&&typeof O.rangeCount==r)nt=function(t){if(M&&y&&t.docSelection.type==g)q(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,r=t.rangeCount;r>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));k(t,t._ranges[t.rangeCount-1],at(t.nativeSelection)),t.isCollapsed=u(t)}else L(t)};else{if(!x||typeof O.isCollapsed!=n||typeof _.collapsed!=n||!h.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;nt=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=Q(n,0),e._ranges=[t],e.rangeCount=1,W(e),e.isCollapsed=u(e)):L(e)}}K.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,r=this.anchorOffset;if(nt(this),e){var a=t.length;if(a!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=r)return!0;for(;a--;)if(!m(t[a],this._ranges[a]))return!0;return!1}};var rt=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var r=0,a=n.length;a>r;++r)m(t,n[r])||e.addRange(n[r]);e.rangeCount||L(e)};K.removeRange=M&&y?function(e){if(this.docSelection.type==g){for(var o,t=this.docSelection.createRange(),n=z(e),r=v(t.item(0)),a=p(r).createControlRange(),i=!1,s=0,f=t.length;f>s;++s)o=t.item(s),o!==n||i?a.add(t.item(s)):i=!0;a.select(),q(this)}else rt(this,e)}:function(e){rt(this,e)};var at;!T&&x&&h.implementsDomRange?(at=S,K.isBackward=function(){return at(this)}):at=K.isBackward=function(){return!1},K.isBackwards=K.isBackward,K.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},K.collapse=function(t,n){ot(this,t);var r=e.createRange(t);r.collapseToPoint(t,n),this.setSingleRange(r),this.isCollapsed=!0},K.collapseToStart=function(){if(!this.rangeCount)throw new c("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},K.collapseToEnd=function(){if(!this.rangeCount)throw new c("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},K.selectAllChildren=function(t){ot(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},K.deleteFromDocument=function(){if(M&&y&&this.docSelection.type==g){for(var t,e=this.docSelection.createRange();e.length;)t=e.item(0),e.remove(t),t.parentNode.removeChild(t);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var r=0,a=n.length;a>r;++r)n[r].deleteContents();this.addRange(n[a-1])}}},K.eachRange=function(e,t){for(var n=0,r=this._ranges.length;r>n;++n)if(e(this.getRangeAt(n)))return t},K.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},K.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},K.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(r){n.push(r[e].apply(r,t))}),n},K.setStart=it(!0),K.setEnd=it(!1),e.rangePrototype.select=function(e){J(this.getDocument()).setSingleRange(this,e)},K.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},K.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)||!1},K.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},K.moveToBookmark=function(t){for(var a,o,n=[],r=0;a=t.rangeBookmarks[r++];)o=e.createRange(this.win),o.moveToBookmark(a),n.push(o);t.backward?this.setSingleRange(n[0],"backward"):this.setRanges(n)},K.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(s.toHtml(t))}),e.join("")},h.implementsTextRange&&(K.getNativeTextRange=function(){var n;if(n=this.docSelection){var a=n.createRange();if(U(a))return a;throw t.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return e.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw t.createError("getNativeTextRange: selection contains no range")}),K.getName=function(){return"WrappedSelection"},K.inspect=function(){return st(this)},K.detach=function(){$(this.win,"delete"),X(this)},G.detachAll=function(){$(null,"deleteAll")},G.inspect=st,G.isDirectionBackward=R,e.Selection=G,e.selectionPrototype=K,e.addShimListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return J(e)}),e=null})});var H=!1,k=function(){H||(H=!0,!N.initialized&&N.config.autoInitialize&&x())};return R&&("complete"==document.readyState?k():(s(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",k,!1),O(window,"load",k))),N},this);